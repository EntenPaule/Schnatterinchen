########################################
# ADXL Settings
########################################

[mcu RP2040]
baud: 115200
restart_method: command
# Obtain definition by "ls -l /dev/serial/by-id/"
serial: /dev/serial/by-id/usb-Klipper_rp2040_4250305031373311-if00

[adxl345]
cs_pin: RP2040:gpio1
spi_bus: spi0a

[resonance_tester]
accel_chip: adxl345
probe_points:
    125,125,50  # an example

# ---- Shaper-Plot-Generatoren (rufen calibrate_shaper.py auf) ----
[gcode_shell_command shaper_plot_x]
command: ~/klipper/scripts/calibrate_shaper.py /tmp/calibration_data_x_*.csv -o ~/printer_data/config/shaper_x.png
timeout: 120.0
verbose: True

[gcode_shell_command shaper_plot_y]
command: ~/klipper/scripts/calibrate_shaper.py /tmp/calibration_data_y_*.csv -o ~/printer_data/config/shaper_y.png
timeout: 120.0
verbose: True

[gcode_shell_command shaper_plot_xy]
command: ~/klipper/scripts/calibrate_shaper.py /tmp/calibration_data_x_*.csv /tmp/calibration_data_y_*.csv -o ~/printer_data/config/shaper_xy.png
timeout: 120.0
verbose: True


[gcode_macro SHAPER_RETEST]
description: "Misst X+Y Resonanzen, erzeugt PNGs und zeigt Pfade an"
gcode:
    {% set xfreq = params.XFREQ|default("") %}
    {% set yfreq = params.YFREQ|default("") %}
    M117 Shaper: Test laeuft...
    G90
    G28
    ; optional: sanfte Limits, damit nichts rappelt
    SET_VELOCITY_LIMIT VELOCITY=200 ACCEL=2000 SQUARE_CORNER_VELOCITY=2

    ; Messungen (schreiben CSV nach /tmp/)
    TEST_RESONANCES AXIS=X
    TEST_RESONANCES AXIS=Y

    ; PNGs generieren
    RUN_SHELL_COMMAND CMD=shaper_plot_x
    RUN_SHELL_COMMAND CMD=shaper_plot_y
    RUN_SHELL_COMMAND CMD=shaper_plot_xy

    ; Limits zurück
    SET_VELOCITY_LIMIT RESET=1

    ; Kurze Auskunft & Hinweise
    { action_respond_info(
      "Shaper-Tests fertig.\n"
      "PNGs: shaper_x.png, shaper_y.png, shaper_xy.png unter ~/printer_data/config/\n"
      "Tipp: Oeffne die Dateien in Mainsail → Machine → Config.\n"
      "Wenn du die empfohlenen Werte uebernehmen willst, fuehre zusaetzlich SHAPER_CALIBRATE aus und SAVE_CONFIG."
    ) }
    M117 Shaper: fertig
